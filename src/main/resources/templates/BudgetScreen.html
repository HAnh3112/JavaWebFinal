<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-pink-50 min-h-screen p-6">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Budget Management</h1>
    <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">+ Add Budget</button>
  </div>

  <h2 class="text-lg font-semibold mb-4">Budget Overview</h2>

  <div id="budget-container" class="space-y-4">
    <!-- Budget cards will be added here -->
  </div>
  
  <!-- Overlay + Modal (Initially hidden) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center hidden z-50">
      <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md space-y-4">
        <h2 class="text-lg font-bold text-gray-700">Add New Budget</h2>

        <!-- Amount input -->
        <div class="relative">
          <input type="number" id="amountInput" min="0" class="w-full border border-gray-300 rounded-lg pl-4 pr-16 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter amount">
          <span class="absolute right-4 top-2.5 text-gray-500 font-semibold">VND</span>
        </div>

        <!-- Dropdown for category -->
        <select id="categorySelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="">Select category...</option>
        </select>
        
          <!-- Month/Year Dropdown -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
          <select id="monthSelect" class="form-select w-full border rounded-md px-3 py-2"></select>
        </div>

        <!-- Confirm button -->
        <div class="text-right">
          <button id="confirmAddBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Confirm</button>
        </div>
      </div>
    </div>


  <script>
    const MONTHS = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];

    function createBudgetCard(budget) {
      const remaining = budget.amount - budget.spentAmount;
      const progress = ((budget.spentAmount / budget.amount) * 100).toFixed(1);
      const colorClass = budget.categoryId % 2 === 0 ? "bg-blue-500" : "bg-red-500";
      const monthText = MONTHS[budget.month - 1] + " " + budget.year;

      return `
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-start">
            <div>
              <div class="flex items-center space-x-2 mb-1">
                <div class="w-3 h-3 rounded-full ${colorClass}"></div>
                <span class="font-semibold text-gray-800">${budget.categoryName}</span>
              </div>
              <p class="text-sm text-gray-500">${monthText}</p>
            </div>
            <div class="flex space-x-2">
              <button class="edit-btn text-gray-400 hover:text-gray-600"
                data-id="${budget.budgetId}"
                data-amount="${budget.amount}"
                data-category="${budget.categoryId}"
                data-month="${budget.month}"
                data-year="${budget.year}"
              >‚úèÔ∏è</button>
              <button class="delete-btn text-gray-400 hover:text-red-500" data-id="${budget.budgetId}">üóëÔ∏è</button>
            </div>
          </div>
          <div class="grid grid-cols-4 gap-4 mt-4 text-sm">
            <div>
              <p class="text-gray-500">Budget</p>
              <p class="font-semibold">$${budget.amount.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-gray-500">Spent</p>
              <p class="font-semibold text-green-600">$${budget.spentAmount.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-gray-500">Remaining</p>
              <p class="font-semibold text-green-600">$${remaining.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-gray-500">Progress</p>
              <p class="font-semibold">${progress}%</p>
            </div>
          </div>
          <div class="mt-4 h-2 w-full bg-gray-200 rounded-full">
            <div class="h-2 bg-green-500 rounded-full" style="width: ${progress}%"></div>
          </div>
        </div>
      `;
    }

    $(document).ready(function () {
      const $container = $('#budget-container');

      fetch('/api/budget/showByMonth?userID=3&month=7&year=2025')
        .then(res => {
          if (!res.ok) throw new Error("Failed to load budget data");
          return res.json();
        })
        .then(budgets => {
          if (!budgets.length) {
            $container.html('<p class="text-gray-500">No budgets available.</p>');
            return;
          }

          budgets.forEach(budget => {
            const card = createBudgetCard(budget);
            $container.append(card);
          });
        })
        .catch(err => {
          $container.html(`<p class="text-red-500">Error: ${err.message}</p>`);
        });
        
        function populateMonthOptions() {
            const now = new Date();
            const $monthSelect = $('#monthSelect');
            $monthSelect.empty();

            const currentMonth = now.getMonth(); // 0-indexed
            const currentYear = now.getFullYear();

            const prevMonthDate = new Date(currentYear, currentMonth - 1);
            const prevMonth = prevMonthDate.getMonth();
            const prevYear = prevMonthDate.getFullYear();

            const MONTH_NAMES = [
              "January", "February", "March", "April", "May", "June",
              "July", "August", "September", "October", "November", "December"
            ];

            $monthSelect.append(`<option value="${prevMonth + 1}-${prevYear}">
              ${MONTH_NAMES[prevMonth]} ${prevYear}</option>`);

            $monthSelect.append(`<option value="${currentMonth + 1}-${currentYear}" selected>
              ${MONTH_NAMES[currentMonth]} ${currentYear}</option>`);
          }

        
        function handleAddBudget() {
          const amount = parseFloat($('#amountInput').val());
          const mode = $('#confirmAddBtn').data('mode');
          const id = $('#confirmAddBtn').data('id');

          if (!amount) {
            alert("Please enter a valid amount.");
            return;
          }

          if (mode === 'edit') {
            // Edit mode: only update amount
            const params = new URLSearchParams({ id, amount });

            fetch(`/api/budget/update?${params.toString()}`, {
              method: 'POST'
            })
              .then(res => res.text())
              .then(response => {
                alert("Budget updated successfully!");
                $('#overlay').addClass('hidden');
                location.reload();
              })
              .catch(err => {
                alert("Error updating budget: " + err.message);
              });

            return;
          }

          // ADD mode
          const categoryID = $('#categorySelect').val();
          const userID = 3; // Hardcoded
          const [month, year] = $('#monthSelect').val().split('-').map(Number);

          if (!categoryID || !month || !year) {
            alert("Please complete all fields.");
            return;
          }

          const params = new URLSearchParams({
            userID,
            categoryID,
            amount,
            month,
            year
          });

          fetch(`/api/budget/insert?${params.toString()}`, {
            method: 'POST'
          })
            .then(res => res.text())
            .then(response => {
              alert("Budget added successfully!");
              $('#overlay').addClass('hidden');
              location.reload();
            })
            .catch(err => {
              alert("Error adding budget: " + err.message);
            });
        }

        
        $('#confirmAddBtn').on('click', handleAddBudget); // bind handler
        
        
        $('.bg-blue-500').on('click', function () {
          $('#overlay').removeClass('hidden');
          populateMonthOptions();

          // Populate dropdown from API
          fetch('/api/categories') // adjust URL to your actual endpoint
            .then(res => res.json())
            .then(data => {
              const $select = $('#categorySelect');
              $select.empty().append('<option value="">Select category...</option>');
              data.forEach(cat => {
                $select.append(`<option value="${cat.categoryId}">${cat.categoryName}</option>`);
              });
            });
        });
        
        $('#overlay').on('click', function (e) {
            if (e.target === this) {
              $(this).addClass('hidden');
            } 
          });
          
        // Delegate click handler after rendering
        $('#budget-container').on('click', '.delete-btn', function () {
          const budgetId = $(this).data('id');

          if (!confirm("Are you sure you want to delete this budget?")) return;

          fetch(`/api/budget/delete?id=${budgetId}`, {
            method: 'DELETE'
          })
            .then(res => {
              if (!res.ok) throw new Error("Delete failed");
              return res.text();
            })
            .then(msg => {
              alert("Deleted successfully!");
              location.reload();
            })
            .catch(err => {
              alert("Error deleting: " + err.message);
            });
        });
        
        $('#budget-container').on('click', '.edit-btn', function () {
          const $btn = $(this);
          const id = $btn.data('id');
          const amount = $btn.data('amount');
          const categoryId = $btn.data('category');
          const month = $btn.data('month');
          const year = $btn.data('year');

          // Open modal
          $('#overlay').removeClass('hidden');
          $('#amountInput').val(amount);
          $('#confirmAddBtn').data('mode', 'edit').data('id', id).text('Update');

          // Disable category & month dropdowns
          $('#categorySelect').prop('disabled', true);
          $('#monthSelect').prop('disabled', true);

          // Load categories and select current one
          fetch('/api/categories')
            .then(res => res.json())
            .then(data => {
              const $select = $('#categorySelect');
              $select.empty().append('<option value="">Select category...</option>');
              data.forEach(cat => {
                const selected = cat.categoryId === categoryId ? 'selected' : '';
                $select.append(`<option value="${cat.categoryId}" ${selected}>${cat.categoryName}</option>`);
              });
            });

          // Set month dropdown to current budget month/year
          populateMonthOptions(`${month}-${year}`);
          $('#monthSelect').val(`${month}-${year}`);
        });

          
          function handleEditButtonClick(budget) {
            $('#overlay').removeClass('hidden');
            $('#amountInput').val(budget.amount);
            $('#confirmAddBtn').data('mode', 'edit').data('budgetId', budget.budgetId);

            // Hide or disable dropdowns
            $('#categorySelect').val(budget.categoryId).prop('disabled', true);
            $('#monthSelect').val(`${budget.month}-${budget.year}`).prop('disabled', true);
          }
          
          function resetModal() {
            $('#amountInput').val('');
            $('#categorySelect').prop('disabled', false).val('');
            $('#monthSelect').prop('disabled', false).val('');
            $('#confirmAddBtn').removeData('mode').removeData('budgetId');
          }

          $('#overlay').on('click', function (e) {
            if (e.target === this) {
              $(this).addClass('hidden');
              resetModal();
            }
          });


    });
  </script>
</body>
</html>
