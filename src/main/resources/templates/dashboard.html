<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #f4f6f9;
      padding: 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .dashboard-header h2 {
      font-size: 26px;
      color: #1f2d3d;
    }

    .overview-text {
      color: #6c757d;
      font-size: 16px;
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h4 {
      font-size: 14px;
      color: #6c757d;
      margin-bottom: 8px;
    }

    .card h3 {
      font-size: 22px;
      font-weight: bold;
      color: #111827;
    }

    .card-icon {
      font-size: 20px;
    }

    .green {
      color: #10b981;
    }

    .red {
      color: #ef4444;
    }

    .blue {
      color: #3b82f6;
    }

    .main-content {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .panel {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      flex: 1;
      min-width: 300px;
    }

    .panel h3 {
      margin-bottom: 15px;
      font-size: 18px;
      color: #111827;
    }

    .empty-message {
      color: #6c757d;
      text-align: center;
      padding: 40px 0;
      font-size: 16px;
    }

    .category {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f1f1f1;
    }

    .category:last-child {
      border-bottom: none;
    }

    .category-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
    }

    .dot {
      height: 12px;
      width: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot.red {
      background-color: #ef4444;
    }

    .dot.orange {
      background-color: #f97316;
    }

    .dot.pink {
      background-color: #ec4899;
    }

    .dot.blue {
      background-color: #3b82f6;
    }

    #monthSelect {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      /* x√°m nh·∫°t */
      background-color: #ffffff;
      color: #374151;
      /* x√°m ƒë·∫≠m */
      font-size: 14px;
      outline: none;
      appearance: none;
      /* ·∫©n style m·∫∑c ƒë·ªãnh */
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg width='12' height='8' viewBox='0 0 12 8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.41 0L6 4.58 10.59 0 12 1.41l-6 6-6-6L1.41 0z' fill='%236b7280'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
      min-width: 150px;

    }

    #monthSelect:hover {
      border-color: #9ca3af;
      /* x√°m ƒë·∫≠m h∆°n khi hover */
    }

    #monthSelect:focus {
      border-color: #3b82f6;
      /* xanh khi focus */
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
    }
  </style>
</head>

<body>
  <div class="dashboard-header">
    <h2>Dashboard</h2>
    <div class="overview-text">
      <select id="monthSelect">

      </select>
    </div>
  </div>

  <div class="cards-container">
    <div class="card">
      <div>
        <h4>Total Balance</h4>
        <h3>$0.00</h3>
      </div>
      <div class="card-icon green">$</div>
    </div>
    <div class="card">
      <div>
        <h4>Monthly Income</h4>
        <h3 id="monthyIncome">$0.00</h3>
      </div>
      <div class="card-icon green">üìà</div>
    </div>
    <div class="card">
      <div>
        <h4>Monthly Expenses</h4>
        <h3 id="monthyExpense">$0.00</h3>
      </div>
      <div class="card-icon red">üìâ</div>
    </div>
    <div class="card">
      <div>
        <h4>Monthly Balance</h4>
        <h3 id = "monthlyBalance">$0.00</h3>
      </div>
      <div class="card-icon blue">üí≥</div>
    </div>
  </div>

  <div class="main-content">
    <div class="panel">
      <h3>Recent Transactions</h3>
      <div class="empty-message">No transactions yet</div>
    </div>

    <div class="panel" id="topCategoriesPanel">
      <h3>Top Spending Categories</h3>
      <div class="category">
        <div class="category-name"><span class="dot red"></span> Food</div>
        <div>$0.00<br><small>0%</small></div>
      </div>
      <div class="category">
        <div class="category-name"><span class="dot orange"></span> Transport</div>
        <div>$0.00<br><small>0%</small></div>
      </div>
      <div class="category">
        <div class="category-name"><span class="dot pink"></span> Entertainment</div>
        <div>$0.00<br><small>0%</small></div>
      </div>
      <div class="category">
        <div class="category-name"><span class="dot blue"></span> Education</div>
        <div>$0.00<br><small>0%</small></div>
      </div>
    </div>
  </div>
</body>

</html>
<script>
  const userId = 1;
  const currentYear = new Date().getFullYear();

  const monthSelect = document.getElementById('monthSelect');
  const overviewText = document.querySelector('.overview-text');

  // Load danh s√°ch th√°ng ngay khi load trang
  fetch('/api/months')
    .then(res => res.json())
    .then(months => {
      months.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.value; // 2025-07
        opt.textContent = m.label; // th√°ng nƒÉm b·∫±ng ch·ªØ
        monthSelect.appendChild(opt);
      });

      // Ch·ªçn th√°ng hi·ªán t·∫°i m·∫∑c ƒë·ªãnh
      const now = new Date();
      const currentValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      monthSelect.value = currentValue; // ch·ªçn ƒë√∫ng option

      const [year, month] = currentValue.split('-').map(Number);
      loadTransactionsByMonth(month, year);
      loadMonthlySummary(month, year);
      loadSpendingCategories(month, year);

    })
    .catch(err => console.error('Error loading months:', err));

  // Khi ng∆∞·ªùi d√πng ƒë·ªïi th√°ng
  monthSelect.addEventListener('change', function () {
    const [year, month] = this.value.split('-').map(Number);
    loadTransactionsByMonth(month, year);
    loadMonthlySummary(month, year);
    loadSpendingCategories(month, year);
  });

  // H√†m g·ªçi API l·∫•y giao d·ªãch theo th√°ng
  function loadTransactionsByMonth(month, year) {
    fetch(`/api/transactions/recentTransactionByMonth?userID=${userId}&month=${month}&year=${year}`)
      .then(response => {
        if (!response.ok) throw new Error("No transactions found.");
        return response.json();
      })
      .then(transactions => {
        const panel = document.querySelector(".panel h3 + .empty-message")?.parentElement || document.querySelector(".panel");
        if (!panel) return;

        panel.innerHTML = '<h3>Recent Transactions</h3>';

        if (!transactions || transactions.length === 0) {
          panel.innerHTML += '<div class="empty-message">No transactions yet</div>';
          return;
        }
        const formatVND = amount => amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });

        transactions.forEach(tx => {
          const div = document.createElement("div");
          div.className = "category";
          div.innerHTML = `
            <div class="category-name">
              <span class="dot ${(tx.categoryType == "Expense") ? 'red' : 'blue'}"></span>
              ${tx.categoryName || 'Uncategorized'}
            </div>
            <div>
              ${formatVND(Math.abs(tx.amount))}<br>
              <small>${new Date(tx.transactionDate).toLocaleDateString()}</small>
            </div>
          `;
          panel.appendChild(div);
        });
      })
      .catch(error => {
        console.error(error);
      });
  }
  //load income and expenses
  async function loadMonthlySummary(month, year) {
    try {
      const res = await fetch(`/api/transactions/summaryTransactionByMonth?userID=${userId}&month=${month}&year=${year}`);
      const data = await res.json();

      if (data.length > 0) {
        const summary = data[0]; // v√¨ API tr·∫£ v·ªÅ m·∫£ng c√≥ 1 object

        // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn VND
        const formatVND = amount => amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });

        // G√°n v√†o HTML
        document.getElementById('monthyIncome').textContent = formatVND(summary.income);
        document.getElementById('monthyExpense').textContent = formatVND(summary.expense);

        const balance = summary.income - summary.expense;
      const balanceEl = document.getElementById('monthlyBalance');
      balanceEl.textContent = formatVND(balance);

      // üëâ ƒê·ªïi m√†u theo gi√° tr·ªã
      if (balance > 0) {
        balanceEl.style.color = 'green';
      } else if (balance < 0) {
        balanceEl.style.color = 'red';
      } else {
        balanceEl.style.color = 'black';
      }
      }
    } catch (err) {
      console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', err);
    }
  }

  async function loadSpendingCategories(month, year) {
  try {
    const res = await fetch(`/api/categories/getSpendingCate?userID=${userId}&month=${month}&year=${year}`);
    const data = await res.json();

    if (!data || data.length === 0) {
      console.log("Kh√¥ng c√≥ d·ªØ li·ªáu chi ti√™u");
      return;
    }

    // 1. T√≠nh t·ªïng chi ti√™u
    const totalExpense = data.reduce((sum, item) => sum + item.amount, 0);

    // 2. L·∫•y panel hi·ªÉn th·ªã
    const panel = document.querySelector("#topCategoriesPanel");
    panel.innerHTML = `<h3>Top Spending Categories</h3>`;

    // 3. Hi·ªÉn th·ªã t·ª´ng category k√®m %
    data.forEach(item => {
      const percent = totalExpense > 0 ? (item.amount / totalExpense * 100).toFixed(1) : 0;

      panel.innerHTML += `
        <div class="category">
          <div class="category-name">
            <span class="dot red"></span> ${item.categoryName}
          </div>
          <div>
            ${item.amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}
            <br><small>${percent}%</small>
          </div>
        </div>
      `;
    });
  } catch (err) {
    console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
  }
}

// V√≠ d·ª• g·ªçi

</script>