<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Categories</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #f4f6f9;
      padding: 20px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    .page-header h2 {
      font-size: 26px;
      color: #1f2d3d;
    }
    .btn-primary {
      background-color: #3b82f6;
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary:hover { background-color: #2563eb; }
    .categories-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .card {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      min-width: 300px;
    }
    .card h3 { font-size: 18px; margin-bottom: 15px; color: #111827; }
    .category-list { list-style: none; padding: 0; margin: 0; }
    .category-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f1f1f1;
      font-size: 15px;
    }
    .category-list li:last-child { border-bottom: none; }
    .dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      color: white;
      font-size: 14px;
    }
    .category-name { display: flex; align-items: center; }
    .badge {
      background: #e5e7eb;
      border-radius: 4px;
      padding: 3px 6px;
      font-size: 12px;
      color: #374151;
      margin-left: 10px;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h3 { margin-bottom: 10px; }
    .modal input, .modal select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .btn-secondary {
      background: #e5e7eb;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-secondary:hover { background: #d1d5db; }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .icon-option {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
      text-align: center;
      cursor: pointer;
    }
    .icon-option.selected {
      border-color: #3b82f6;
      background: #e0f2fe;
    }
  </style>
</head>
<body>
  <div class="page-header">
    <h2>Category Management</h2>
    <button id="openAddCategory" class="btn-primary">+ Add Category</button>
  </div>

  <div class="categories-container">
    <div class="card">
      <h3>Income Categories</h3>
      <ul class="category-list" id="incomeCategories"></ul>
    </div>
    <div class="card">
      <h3>Expense Categories</h3>
      <ul class="category-list" id="expenseCategories"></ul>
    </div>
  </div>

  <!-- Modal Add Category -->
  <div id="addCategoryModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h3>Add New Category</h3>
      <label>Name</label>
      <input type="text" id="catName" placeholder="Category name">

      <label>Type</label>
      <select id="catType">
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
      </select>

      <label>Color</label>
      <div style="display:flex; align-items:center; gap:8px;">
        <input type="color" id="catColor" value="#9ca3af">
        <span id="colorPreviewDot" style="width:16px; height:16px; border-radius:50%; background:#9ca3af; display:inline-block;"></span>
        <span id="colorPreviewText">#9ca3af</span>
      </div>

      <label>Icon</label>
      <div id="iconGrid" class="icon-grid"></div>

      <div class="modal-actions">
        <button id="cancelAddCat" class="btn-secondary">Cancel</button>
        <button id="saveAddCat" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

<script>
  const userId = 3;
  const iconMap = {
    57946: "fastfood",
    57815: "directions_car",
    58778: "shopping_bag",
    58235: "lightbulb",
    58381: "movie",
    57522: "attach_money",
    58136: "home",
    58822: "smartphone",
    58328: "medical_services",
    58713: "school",
    58007: "flight",
    58856: "sports_esports",
  };

  let selectedIconCode = null;

  // Render icon grid in modal
  const iconGrid = document.getElementById("iconGrid");
  iconGrid.innerHTML = Object.entries(iconMap)
    .map(([code, name]) => `
      <div class="icon-option" data-code="${code}">
        <span class="material-icons">${name}</span>
      </div>
    `).join("");

  iconGrid.addEventListener("click", (e) => {
    const option = e.target.closest(".icon-option");
    if (!option) return;
    document.querySelectorAll(".icon-option").forEach(opt => opt.classList.remove("selected"));
    option.classList.add("selected");
    selectedIconCode = option.dataset.code;
  });

  // Load categories
  fetch(`/api/categories`)
    .then(res => res.json())
    .then(data => {
      const incomeList = document.getElementById("incomeCategories");
      const expenseList = document.getElementById("expenseCategories");

      const renderCategory = (cat) => `
        <li>
            <div class="category-name">
            <span class="dot" style="background-color:${cat.colorCodeHex || '#9ca3af'}">
                <span class="material-icons" style="font-size:16px;line-height:1;color:white;">
                ${iconMap[cat.iconCode] || "category"}
                </span>
            </span>
            ${cat.name}
            </div>
        </li>
        `;

      data.filter(cat => cat.type?.toLowerCase() === "income")
          .forEach(cat => incomeList.innerHTML += renderCategory(cat));

      data.filter(cat => cat.type?.toLowerCase() === "expense")
          .forEach(cat => expenseList.innerHTML += renderCategory(cat));
    })
    .catch(console.error);

  // Modal handling
  const addBtn = document.getElementById("openAddCategory");
  const modal = document.getElementById("addCategoryModal");
  const cancelBtn = document.getElementById("cancelAddCat");
  const saveBtn = document.getElementById("saveAddCat");

  addBtn.addEventListener("click", () => {
    modal.style.display = "flex";
  });
  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  // Đóng modal khi click ra ngoài
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
    }
  });

  // Color preview update
  const colorInput = document.getElementById("catColor");
  const previewDot = document.getElementById("colorPreviewDot");
  const previewText = document.getElementById("colorPreviewText");

  colorInput.addEventListener("input", () => {
    const colorVal = colorInput.value;
    previewDot.style.backgroundColor = colorVal;
    previewText.textContent = colorVal;
  });

  saveBtn.addEventListener("click", () => {
    const name = document.getElementById("catName").value.trim();
    const type = document.getElementById("catType").value;
    const color = document.getElementById("catColor").value;

    if (!name) {
      alert("Please enter category name");
      return;
    }
    if (!selectedIconCode) {
      alert("Please select an icon");
      return;
    }

    fetch(`/api/categories/insert?userID=${userId}&name=${encodeURIComponent(name)}&iconCode=${selectedIconCode}&colorCode=${encodeURIComponent(color)}&type=${encodeURIComponent(type)}`, {
      method: "POST"
    })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        modal.style.display = "none";
        location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("Error adding category");
      });
  });
</script>
</body>
</html>
