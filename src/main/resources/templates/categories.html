<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Categories</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
    body { background-color: #f4f6f9; padding: 20px; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-header h2 { font-size: 26px; color: #1f2d3d; }
    .btn-primary { background-color: #3b82f6; border: none; color: white; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-primary:hover { background-color: #2563eb; }
    .categories-container { display: flex; gap: 20px; flex-wrap: wrap; }
    .card { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); min-width: 300px; }
    .card h3 { font-size: 18px; margin-bottom: 15px; color: #111827; }
    .category-list { list-style: none; padding: 0; margin: 0; }
    .category-list li { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; font-size: 15px; }
    .category-list li:last-child { border-bottom: none; }
    .dot { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; color: white; font-size: 14px; }
    .category-name { display: flex; align-items: center; }
    .actions { display: flex; gap: 8px; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #555; }
    .action-btn:hover { color: #000; }
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: white; padding: 20px; border-radius: 10px; width: 350px; display: flex; flex-direction: column; gap: 10px; max-height: 80vh; overflow-y: auto; }
    .modal h3 { margin-bottom: 10px; }
    .modal input, .modal select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .btn-secondary { background: #e5e7eb; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
    .btn-secondary:hover { background: #d1d5db; }
    .icon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .icon-option { border: 1px solid #ccc; border-radius: 6px; padding: 6px; text-align: center; cursor: pointer; }
    .icon-option.selected { border-color: #3b82f6; background: #e0f2fe; }
  </style>
</head>
<body>
   <!-- Auth check -->
  <script src="/static/js/auth.js"></script>
  <script>
    checkAuth(); // Kiểm tra token trước khi hiển thị nội dung
  </script>
  <div class="page-header">
    <h2>Category Management</h2>
    <button id="openAddCategory" class="btn-primary">+ Add Category</button>
  </div>

  <div class="categories-container">
    <div class="card">
      <h3>Income Categories</h3>
      <ul class="category-list" id="incomeCategories"></ul>
    </div>
    <div class="card">
      <h3>Expense Categories</h3>
      <ul class="category-list" id="expenseCategories"></ul>
    </div>
  </div>

  <!-- Modal Add/Edit -->
  <div id="addCategoryModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h3 id="modalTitle">Add New Category</h3>
      <label>Name</label>
      <input type="text" id="catName" placeholder="Category name">
      <label>Type</label>
      <select id="catType">
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
      </select>
      <label>Color</label>
      <div style="display:flex; align-items:center; gap:8px;">
        <input type="color" id="catColor" value="#9ca3af">
        <span id="colorPreviewDot" style="width:16px; height:16px; border-radius:50%; background:#9ca3af; display:inline-block;"></span>
        <span id="colorPreviewText">#9ca3af</span>
      </div>
      <label>Icon</label>
      <div id="iconGrid" class="icon-grid"></div>
      <div class="modal-actions">
        <button id="cancelAddCat" class="btn-secondary">Cancel</button>
        <button id="saveAddCat" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

<script>
const userId = 1;
const iconMap = {
  57946: "fastfood",
  57815: "directions_car",
  58778: "shopping_bag",
  58235: "lightbulb",
  58381: "movie",
  57522: "attach_money",
  58136: "home",
  58822: "smartphone",
  58328: "medical_services",
  58713: "school",
  58007: "flight",
  58856: "sports_esports",
};
let selectedIconCode = null;
let allCategories = [];
let editMode = false;
let editId = null;

// Render icon grid
const iconGrid = document.getElementById("iconGrid");
iconGrid.innerHTML = Object.entries(iconMap)
  .map(([code, name]) => `<div class="icon-option" data-code="${code}"><span class="material-icons">${name}</span></div>`).join("");
iconGrid.addEventListener("click", e => {
  const opt = e.target.closest(".icon-option");
  if (!opt) return;
  document.querySelectorAll(".icon-option").forEach(o => o.classList.remove("selected"));
  opt.classList.add("selected");
  selectedIconCode = opt.dataset.code;
});

// Load categories
function loadCategories(){
  fetch(`/api/categories?userId=${userId}`)
    .then(res => res.json())
    .then(data => {
      allCategories = data;
      renderLists();
    }).catch(console.error);
}
function renderLists(){
  const incomeList = document.getElementById("incomeCategories");
  const expenseList = document.getElementById("expenseCategories");
  incomeList.innerHTML = "";
  expenseList.innerHTML = "";
  allCategories.filter(c=>c.type.toLowerCase()==="income").forEach(cat=>incomeList.innerHTML += renderCategory(cat));
  allCategories.filter(c=>c.type.toLowerCase()==="expense").forEach(cat=>expenseList.innerHTML += renderCategory(cat));
}
function renderCategory(cat){
  return `<li>
    <div class="category-name">
      <span class="dot" style="background-color:${cat.colorCodeHex || '#9ca3af'}">
        <span class="material-icons" style="font-size:16px;line-height:1;color:white;">${iconMap[cat.iconCode] || "category"}</span>
      </span>${cat.name}
    </div>
    <div class="actions">
      <button class="action-btn" onclick="startEdit(${cat.categoryId})">
        <span class="material-icons">edit</span>
      </button>
      <button class="action-btn" onclick="deleteCategory(${cat.categoryId})">
        <span class="material-icons">delete</span>
      </button>
    </div>
  </li>`;
}

// Modal handling
const modal = document.getElementById("addCategoryModal");
document.getElementById("openAddCategory").addEventListener("click", () => openModal(false));
document.getElementById("cancelAddCat").addEventListener("click", () => modal.style.display="none");
modal.addEventListener("click", e => { if(e.target===modal) modal.style.display="none"; });
const colorInput = document.getElementById("catColor");
const previewDot = document.getElementById("colorPreviewDot");
const previewText = document.getElementById("colorPreviewText");
colorInput.addEventListener("input", () => {
  previewDot.style.backgroundColor = colorInput.value;
  previewText.textContent = colorInput.value;
});

function openModal(isEdit, data){
  editMode = isEdit;
  document.getElementById("modalTitle").textContent = isEdit ? "Edit Category" : "Add New Category";
  modal.style.display = "flex";
  if(isEdit && data){
    editId = data.categoryId;
    document.getElementById("catName").value = data.name;
    document.getElementById("catType").value = data.type.charAt(0).toUpperCase() + data.type.slice(1).toLowerCase();
    document.getElementById("catColor").value = data.colorCodeHex;
    previewDot.style.backgroundColor = data.colorCodeHex;
    previewText.textContent = data.colorCodeHex;
    selectedIconCode = data.iconCode;
    document.querySelectorAll(".icon-option").forEach(opt=>{
      opt.classList.toggle("selected", opt.dataset.code==data.iconCode);
    });
  } else {
    editId = null;
    document.getElementById("catName").value = "";
    document.getElementById("catType").value = "Income";
    document.getElementById("catColor").value = "#9ca3af";
    previewDot.style.backgroundColor = "#9ca3af";
    previewText.textContent = "#9ca3af";
    selectedIconCode = null;
    document.querySelectorAll(".icon-option").forEach(opt=>opt.classList.remove("selected"));
  }
}

// Save
document.getElementById("saveAddCat").addEventListener("click", () => {
  const name = document.getElementById("catName").value.trim();
  const type = document.getElementById("catType").value;
  const color = document.getElementById("catColor").value;

  if (!name) { alert("Please enter category name"); return; }
  if (!selectedIconCode) { alert("Please select an icon"); return; }

  const duplicate = allCategories.some(c =>
    c.type.toLowerCase() === type.toLowerCase() &&
    c.name.toLowerCase() === name.toLowerCase() &&
    (!editMode || c.categoryId !== editId)
  );
  if (duplicate) { alert("Category already exists in this type"); return; }

  if (editMode) {
    fetch(`/api/categories/update?id=${editId}&name=${encodeURIComponent(name)}&iconCode=${selectedIconCode}&colorCode=${encodeURIComponent(color)}&type=${encodeURIComponent(type)}`, {method:"PUT"})
      .then(() => {
        alert("Category updated successfully");
        modal.style.display = "none";
        loadCategories();
      })
      .catch(err => {
        console.error(err);
        alert("Error updating category");
      });
  } else {
    fetch(`/api/categories/insert?userID=${userId}&name=${encodeURIComponent(name)}&iconCode=${selectedIconCode}&colorCode=${encodeURIComponent(color)}&type=${encodeURIComponent(type)}`, { method: "POST" })
      .then(() => {
        alert("Category added successfully");
        modal.style.display = "none";
        loadCategories();
      })
      .catch(err => {
        console.error(err);
        alert("Error adding category");
      });
  }
});

function startEdit(id){
  const cat = allCategories.find(c=>c.categoryId===id);
  if(cat) openModal(true, cat);
}
function deleteCategory(id) {
  if (!confirm("Delete this category?")) return;
  fetch(`/api/categories/delete?id=${id}`, { method: "DELETE" })
    .then(() => {
      alert("Category deleted successfully");
      loadCategories();
    })
    .catch(err => {
      console.error(err);
      alert("Error deleting category");
    });
}


// Init
loadCategories();
</script>
</body>
</html>
